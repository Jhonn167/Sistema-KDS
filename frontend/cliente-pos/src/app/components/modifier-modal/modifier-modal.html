<!-- src/app/components/modifier-modal/modifier-modal.component.html -->
<div class="modal-overlay" (click)="close.emit()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ product?.nombre }}</h2>
      <button class="close-btn" (click)="close.emit()">&times;</button>
    </div>
    <div class="modal-body" [formGroup]="modifierForm">
      
      <div *ngFor="let group of product?.modificadores" class="modifier-group">
        
        <!-- Título del grupo con contador (si aplica) -->
        <h4 class="group-title">
          {{ group.nombre }}
          <!-- CORRECCIÓN: Muestra el límite y el total correctamente -->
          <span *ngIf="group.tipo_seleccion === 'seleccionar_cantidad'" 
                class="group-limit"
                [class.invalid]="totalSeleccionado[group.id_grupo] !== group.limite_seleccion">
            (Selecciona {{ group.limite_seleccion }}) - Total: {{ totalSeleccionado[group.id_grupo] || 0 }} / {{ group.limite_seleccion }}
          </span>
        </h4>
        
        <!-- Caso: Selección Única (Radio) -->
        <div *ngIf="group.tipo_seleccion === 'seleccionar_uno'">
          <div *ngFor="let option of group.opciones" class="option-item">
            <input type="radio" [formControlName]="group.id_grupo.toString()" [value]="option.id_opcion" [id]="'opt-' + option.id_opcion">
            <label [for]="'opt-' + option.id_opcion">
              {{ option.nombre }} <span class="price">(+{{ option.precio_adicional | currency:'MXN' }})</span>
            </label>
          </div>
        </div>

        <!-- Caso: Múltiples Opciones (Checkbox) -->
        <div *ngIf="group.tipo_seleccion === 'seleccionar_varios'" [formGroupName]="group.id_grupo.toString()">
           <div *ngFor="let option of group.opciones" class="option-item">
            <input type="checkbox" [formControlName]="option.id_opcion.toString()" [id]="'opt-' + option.id_opcion">
            <label [for]="'opt-' + option.id_opcion">
              {{ option.nombre }} <span class="price">(+{{ option.precio_adicional | currency:'MXN' }})</span>
            </label>
          </div>
        </div>

        <!-- --- NUEVO CASO: Selección por Cantidad (Paquete) --- -->
        <div *ngIf="group.tipo_seleccion === 'seleccionar_cantidad'" [formGroupName]="group.id_grupo.toString()" class="quantity-group">
           <div *ngFor="let option of group.opciones" class="option-item quantity-item">
            <label [for]="'opt-' + option.id_opcion">
              {{ option.nombre }} <span class="price">(+{{ option.precio_adicional | currency:'MXN' }})</span>
            </label>
            <div class="quantity-controls">
              <button type="button" class="quantity-btn" (click)="changeQuantity(group.id_grupo.toString(), option.id_opcion.toString(), -1)">-</button>
              <span>{{ modifierForm.get(group.id_grupo.toString())?.get(option.id_opcion.toString())?.value }}</span>
              <button type="button" class="quantity-btn" 
                      (click)="changeQuantity(group.id_grupo.toString(), option.id_opcion.toString(), 1)"
                      [disabled]="(totalSeleccionado[group.id_grupo] || 0) >= group.limite_seleccion">
                +
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="close.emit()">Cancelar</button>
      <!-- Botón de confirmar se deshabilita si el paquete no está completo -->
      <button class="btn btn-primary" (click)="onConfirm()" [disabled]="isConfirmDisabled()">Confirmar y Añadir</button>
    </div>
  </div>
</div>